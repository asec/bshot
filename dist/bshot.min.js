/*! BShot - v0.1.0 - 2014-01-29
* Copyright (c) 2014 Roland ZsÃ¡mboki; Licensed MIT */
!function(a){var b=null,c=1;a.fn.bShot=function(e,f){if(this.get(0)!==document)return!1;var g=a(this);e=e||"generate";var h=a.extend(a.fn.bShot.defaults,f);switch("object"==typeof e&&(h=a.extend(h,e),e="generate"),h.error&&"function"==typeof h.error&&g.on("bShotError",h.error),h.done&&"function"==typeof h.done&&g.on("bShotDone",h.done),e){default:if(b=new d.Generator,!b.isSupported){g.trigger("bShotError",[c]);break}b.generate(g)}return this},a.fn.bShot.defaults={};var d;d={model:{rendertree:{nodes:{tags:{}}}},resources:{},utils:{}},d.resources.ResourceManager=function(){this.resources={},this.total=0,this.loaded=0},d.resources.ResourceManager.prototype.set=function(a,b){console.log(["This method is not implemented",a,b])},d.resources.ResourceManager.prototype.get=function(a){console.log(["This method is not implemented",a])},d.resources.ResourceManager.prototype.load=function(a){console.log(["This method is not implemented",a])},d.resources.ImageManager=function(){},d.resources.ImageManager.prototype=new d.resources.ResourceManager,d.resources.ImageManager.prototype.set=function(a,b){this.resources.hasOwnProperty(a)||this.total++,this.resources[a]=b},d.resources.ImageManager.prototype.get=function(a){return this.resources[a]},d.resources.ImageManager.prototype.load=function(a){this.loaded=0;var b,c=this,d=function(){c.loaded++,c.checkIfDone(a)};for(var e in this.resources)if("Image"!=typeof this.resources[e])b=new Image,b.onload=d,b.src=e,this.resources[e]=b;else{var f=!0;b=this.resources[e],b.complete||(f=!1),"undefined"!=typeof b.naturalWidth&&0===b.naturalWidth&&(f=!1),f?(this.loaded++,c.checkIfDone(a)):b.onload=d}},d.resources.ImageManager.prototype.checkIfDone=function(a){return this.loaded===this.total?"function"==typeof a?a.call(this):!0:!1},d.resources.ImageManager=new d.resources.ImageManager,d.utils.getStyles=function(a,b){return b=!!b,a instanceof jQuery||(a=jQuery(a)),a.data("bshot.styleObject")||a.data("bshot.styleObject",b?a.find("body").getStyleObject():a.getStyleObject()),a.data("bshot.styleObject")},d.utils.isBlock=function(a){var b=this.getStyles(a);return console.log(b.display),"block"===b.display||"list-item"===b.display||"table"===b.display},d.utils.isInline=function(a){if(3===a.nodeType)return!0;var b=this.getStyles(a);return"inline"===b.display||"inline-table"===b.display||"inline-block"===b.display},d.utils.getBackgroundImage=function(a){return a.substr(4,a.length-5).replace(/"|'/g,"")},d.utils.collapseWhiteSpaces=function(a){return a.replace(/\s+/g," ")},d.utils.renderBackground=function(a,b){var c=a.isRoot,e=a.renderingStyle,f=a.width,g=a.height,h=a.yPos,i=a.xPos;if(!c){var j=parseInt(e.borderLeftWidth,10),k=parseInt(e.borderTopWidth,10);f-=j+parseInt(e.borderRightWidth,10),i+=j,g-=k+parseInt(e.borderBottomWidth,10),h+=k}if(b.save(),b.translate(i+.49,h),b.fillStyle=e.backgroundColor,b.beginPath(),b.rect(0,0,f,g),b.fill(),e.backgroundImage&&"none"!==e.backgroundImage){var l=d.resources.ImageManager.get(d.utils.getBackgroundImage(e.backgroundImage)),m=e.backgroundPosition,n=null;if(m&&m.length>0){m=m.split(" "),n=[0,0];for(var o=0;2>o;o++){var p=-1===m[o].indexOf("%");if(m[o]=parseInt(m[o],10),0!==m[o])if(p)n[o]=m[o];else{var q=a.getContainingBlock().renderObject,r=0===o?"width":"height";n[o]=Math.abs(l[r]-q[r]),n[o]=-1*Math.round(n[o]*(m[o]/100))}}b.save(),b.translate(n[0],n[1])}var s=b.createPattern(l,e.backgroundRepeat);b.fillStyle=s,b.fill(),n&&b.restore()}this.renderBorder(a,b,"top",f,g,0,0,"none"!==e.borderLeftStyle&&"hidden"!==e.borderLeftStyle?parseInt(e.borderLeftWidth,10):0,"none"!==e.borderRightStyle&&"hidden"!==e.borderRightStyle?parseInt(e.borderRightWidth,10):0),this.renderBorder(a,b,"right",f,g,0,0,"none"!==e.borderTopStyle&&"hidden"!==e.borderTopStyle?parseInt(e.borderTopWidth,10):0,"none"!==e.borderBottomStyle&&"hidden"!==e.borderBottomStyle?parseInt(e.borderBottomWidth,10):0),this.renderBorder(a,b,"bottom",f,g,0,0,"none"!==e.borderLeftStyle&&"hidden"!==e.borderLeftStyle?parseInt(e.borderLeftWidth,10):0,"none"!==e.borderRightStyle&&"hidden"!==e.borderRightStyle?parseInt(e.borderRightWidth,10):0),this.renderBorder(a,b,"left",f,g,0,0,"none"!==e.borderTopStyle&&"hidden"!==e.borderTopStyle?parseInt(e.borderTopWidth,10):0,"none"!==e.borderBottomStyle&&"hidden"!==e.borderBottomStyle?parseInt(e.borderBottomWidth,10):0),b.restore()},d.utils.renderBorder=function(a,b,c,d,e,f,g,h,i){var j=a.renderingStyle,k="border"+c.substr(0,1).toUpperCase()+c.substr(1);if("none"===j[k+"Style"]||"hidden"===j[k+"Style"])return!1;var l,m;switch(c){case"top":l={x:f-h,y:g-parseInt(j[k+"Width"],10)},m={x:f+d+i,y:l.y};break;case"bottom":l={x:f-h,y:g+e+parseInt(j[k+"Width"],10)},m={x:f+d+i,y:l.y};break;case"left":l={x:f-parseInt(j[k+"Width"],10),y:g-h},m={x:l.x,y:g+e+i};break;case"right":l={x:f+d+parseInt(j[k+"Width"],10),y:g-h},m={x:l.x,y:g+e+i}}"dashed"!==j[k+"Style"]&&"dotted"!==j[k+"Style"]||"function"!=typeof b.setLineDash||b.setLineDash("dotted"===j[k+"Style"]?[1,1]:[2,2]),b.save(),b.beginPath(),b.translate(.49*("right"===c||"bottom"===c?-1:1),.49*("right"===c||"bottom"===c?-1:1)),b.moveTo(l.x,l.y),b.lineTo(m.x,m.y),b.strokeStyle=j[k+"Color"],b.lineWidth=parseInt(j[k+"Width"],10),b.stroke(),b.restore()},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),String.prototype.ucFirst||(String.prototype.ucFirst=function(){return this.substring(0,1).toUpperCase()+this.substring(1).toLowerCase()}),function(a){a.fn.getStyleObject=function(){var a,b,c=this.get(0),d={};if(window.getComputedStyle){var e=function(a,b){return b.toUpperCase()};a=window.getComputedStyle(c,null);for(var f=0;f<a.length;f++){b=a[f];var g=b.replace(/\-([a-z])/g,e),h=a.getPropertyValue(b);d[g]=h}return d}if(c.currentStyle){a=c.currentStyle;for(b in a)d[b]=a[b];return d}return this.css()}}(jQuery),d.model.rendertree.RenderObject=function(){this.node=null,this.rtNode=null,this.renderingStyle=null,this.containingLayer=null,this.containingBlock=null,this.isRoot=!1,this.xPos=null,this.yPos=null,this.nextX=null,this.nextY=null,this.width=null,this.height=null,this.tagName="RenderObject"},d.model.rendertree.RenderObject.prototype.layout=function(a,b,c){this.determinePosition(a,b,c),this.width=this.determineWidth();for(var d=0,e=0;e<this.rtNode.childNodes.length;e++)d=Math.max(d,this.rtNode.childNodes[e].renderObject.layout(this.nextX,this.nextY,this));return this.height=this.determineHeight(d),this.height},d.model.rendertree.RenderObject.prototype.determinePosition=function(a,b,c){a=null,b=null,c=null},d.model.rendertree.RenderObject.prototype.determineWidth=function(){},d.model.rendertree.RenderObject.prototype.determineHeight=function(a){a=null},d.model.rendertree.RenderObject.prototype.paint=function(a){this.doPainting(a);for(var b=0;b<this.rtNode.childNodes.length;b++)this.rtNode.childNodes[b].renderObject.paint(a)},d.model.rendertree.RenderObject.prototype.doPainting=function(a){a=null},d.model.rendertree.RenderObject.prototype.setNode=function(a){this.node=a,this.renderingStyle=a.getStyleObject(),this.computeCSSValues()},d.model.rendertree.RenderObject.prototype.computeCSSValues=function(){},d.model.rendertree.RenderObject.prototype.clone=function(){var b=document.createElement(this.tagName);return b.renderObject=a.extend(!0,{},this),b.renderObject.rtNode=b,b.id=d.Factory.getNextTreeNodeId(),b},d.model.rendertree.RenderObject.prototype.getContainingBlock=function(){for(var a=this.rtNode;a.parentNode;)a=a.parentNode;return a},d.model.rendertree.RenderBox=function(a){this.positionedObjects=[],this.continuation=null,this.isInlineContinuation=!1,this.tagName="RenderBox",a&&this.setNode(a)},d.model.rendertree.RenderBox.prototype=new d.model.rendertree.RenderObject,d.model.rendertree.RenderBox.prototype.computeCSSValues=function(){var a=this.renderingStyle.float;this.isPositioned()?(this.renderingStyle.float="none",this.renderingStyle.float=this._calcCSSDisplayValue(a)):("none"!==a||this.isRoot)&&(this.renderingStyle.float=this._calcCSSDisplayValue(a))},d.model.rendertree.RenderBox.prototype._calcCSSDisplayValue=function(a){return this.isRoot&&"list-item"===a?"block":"inline-table"===a?"table":"inline"===a||"table-row-group"===a||"table-column"===a||"table-column-group"===a||"table-header-group"===a||"table-footer-group"===a||"table-row"===a||"table-cell"===a||"table-caption"===a||"inline-block"===a?"block":a},d.model.rendertree.RenderBox.prototype.isPositioned=function(){return"absolute"===this.renderingStyle.display||"fixed"===this.renderingStyle.display},d.model.rendertree.RenderBox.prototype.isRelPositioned=function(){return"relative"===this.renderingStyle.display},d.model.rendertree.RenderBox.prototype.isReplaced=function(){return!1},d.model.rendertree.RenderBox.prototype.isInline=function(){var a=this.renderingStyle.display;return!this.isPositioned()&&("inline"===a||"inline-block"===a||"inline-table"===a)},d.model.rendertree.RenderBox.prototype.isInlineBlockOrInlineTable=function(){return"inline-block"===this.renderingStyle.display||"inline-table"===this.renderingStyle.display},d.model.rendertree.RenderBox.prototype.isInlineFlow=function(){return this.isInline()&&!this.isInlineBlockOrInlineTable()},d.model.rendertree.RenderBox.prototype.insertPositionedElement=function(a){return a.isPositioned()?(this.positionedObjects.push(a),void 0):(console.warn(["Trying to insert non-positioned element as a positioned child.",this]),!1)},d.model.rendertree.RenderBox.prototype.isAnonymousBlock=function(){return!1},d.model.rendertree.RenderBox.prototype.childrenInline=function(){for(var a=!0,b=0;b<this.rtNode.childNodes.length;b++)a=a&&this.rtNode.childNodes[b].renderObject.isInline();return a},d.model.rendertree.RenderBox.prototype.determinePosition=function(){this.node&&1===this.node.get(0).nodeType&&this.node.offset()?(this.xPos=this.node.offset().left,this.yPos=this.node.offset().top):(this.xPos=0,this.yPos=0)},d.model.rendertree.RenderBox.prototype.determineWidth=function(){return this.node&&1===this.node.get(0).nodeType&&this.node.outerWidth()?this.node.outerWidth():0},d.model.rendertree.RenderBox.prototype.determineHeight=function(){return this.node&&1===this.node.get(0).nodeType&&this.node.outerHeight()?this.node.outerHeight():0},d.model.rendertree.RenderView=function(a){this.setNode(a),this.isRoot=!0,this.tagName="RenderView"},d.model.rendertree.RenderView.prototype=new d.model.rendertree.RenderBox,d.model.rendertree.RenderView.prototype.setNode=function(a){this.node=a,this.renderingStyle=a.find("body").getStyleObject()},d.model.rendertree.RenderView.prototype.determinePosition=function(){this.xPos=0,this.yPos=0,this.nextX=0,this.nextY=0},d.model.rendertree.RenderView.prototype.determineWidth=function(){return this.node.outerWidth(!0)},d.model.rendertree.RenderView.prototype.determineHeight=function(){return this.node.outerHeight(!0)},d.model.rendertree.RenderView.prototype.doPainting=function(a){return this.width&&this.height?(d.utils.renderBackground(this,a),void 0):!1},d.model.rendertree.nodes.RenderInline=function(a){a&&this.setNode(a),this.tagName="RenderInline"},d.model.rendertree.nodes.RenderInline.prototype=new d.model.rendertree.RenderBox,d.model.rendertree.nodes.RenderInline.prototype.isInline=function(){return!0},d.model.rendertree.nodes.RenderInline.prototype.isInlineFlow=function(){return!0},d.model.rendertree.nodes.RenderBlock=function(a){a&&this.setNode(a),this.tagName="RenderBlock"},d.model.rendertree.nodes.RenderBlock.prototype=new d.model.rendertree.RenderBox,d.model.rendertree.nodes.RenderBlock.prototype.doPainting=function(a){return this.width&&this.height?(d.utils.renderBackground(this,a),void 0):!1},d.model.rendertree.nodes.RenderText=function(a){a&&this.setNode(a),this.tagName="RenderText"},d.model.rendertree.nodes.RenderText.prototype=new d.model.rendertree.nodes.RenderInline,d.model.rendertree.nodes.RenderText.prototype.setNode=function(a){this.node=a},d.model.rendertree.nodes.RenderAnonymousBlock=function(a){a&&this.setNode(a),this.tagName="RenderAnonymousBlock"},d.model.rendertree.nodes.RenderAnonymousBlock.prototype=new d.model.rendertree.RenderBox,d.model.rendertree.nodes.RenderAnonymousBlock.prototype.computeCSSValues=function(){},d.model.rendertree.nodes.RenderAnonymousBlock.prototype.isAnonymousBlock=function(){return!0},d.model.rendertree.nodes.RenderAnonymousBlock.prototype.isPositioned=function(){return!1},d.model.rendertree.nodes.RenderAnonymousBlock.prototype.isRelPositioned=function(){return!1},d.model.rendertree.nodes.RenderAnonymousBlock.prototype.isInline=function(){return!1},d.model.rendertree.nodes.RenderAnonymousBlock.prototype.isInlineBlockOrInlineTable=function(){return!1},d.model.rendertree.nodes.RenderAnonymousBlock.prototype.isInlineFlow=function(){return!1},d.model.rendertree.nodes.RenderReplaced=function(a){a&&this.setNode(a),this.tagName="RenderReplaced"},d.model.rendertree.nodes.RenderReplaced.prototype=new d.model.rendertree.RenderBox,d.model.rendertree.nodes.tags.Img=function(a){a&&this.setNode(a),this.tagName="TagImg"},d.model.rendertree.nodes.tags.Img.prototype=new d.model.rendertree.nodes.RenderReplaced,d.model.rendertree.nodes.tags.Img.prototype.doPainting=function(a){var b=this.xPos,c=this.yPos,e=this.width,f=this.height;a.save(),a.translate(b+.49,c);var g=d.resources.ImageManager.get(this.node.prop("src"));if(g){var h=a.createPattern(g,"no-repeat");a.beginPath(),a.rect(0,0,e,f),a.fillStyle=h,a.fill()}a.restore()},d.Factory={nextTreeNodeId:0,createRenderTreeNode:function(a){var b,c,e=a.get(0);if(3===e.nodeType)b=new d.model.rendertree.nodes.RenderText(a);else if(9===e.nodeType)b=new d.model.rendertree.RenderView(a),c=document.createDocumentFragment();else{if(1!==e.nodeType)return null;if(b=new d.model.rendertree.RenderBox(a),"none"===b.renderingStyle.display)return null;var f=a.get(0).tagName.ucFirst();if("undefined"!=typeof d.model.rendertree.nodes.tags[f])b=new d.model.rendertree.nodes.tags[f](a);else switch(b.renderingStyle.display){case"block":case"inline-block":b=new d.model.rendertree.nodes.RenderBlock(a);break;case"inline":b=new d.model.rendertree.nodes.RenderInline(a)}}return c||(c=document.createElement(b.tagName)),c.id=this.getNextTreeNodeId()+"."+a.attr("class"),c.renderObject=b,b.rtNode=c,c},createRenderTreeAnonymousBlock:function(){var a=new d.model.rendertree.nodes.RenderAnonymousBlock,b=document.createElement(a.tagName);return b.id=this.getNextTreeNodeId(),b.renderObject=a,a.rtNode=b,b},getNextTreeNodeId:function(){return this.nextTreeNodeId++}},d.Generator=function(){this.canvas=document.createElement("canvas"),this.isSupported=!0,this.layers={},this.renderTree=null,this.canDraw=!1,this.canvas&&this.canvas.getContext?this.ctx=this.canvas.getContext("2d"):this.isSupported=!1},d.Generator.prototype.generate=function(a){var b=this;console.group("-== Building render tree ==-"),this.canDraw=!1,this.doBuildRenderTree(a.get(0),null),console.log(this.renderTree),console.log(d.resources.ImageManager),d.resources.ImageManager.load(function(){b.doPaint()}),console.groupEnd(),console.group("-== Checking invariants ==-"),this.checkInvariants(this.renderTree),console.groupEnd(),console.group("-== Doing layout ==-"),this.doLayout(),console.groupEnd(),console.group("-== Painting ==-"),this.canDraw=!0,this.doPaint(),console.groupEnd(),document.body.innerHTML="",document.body.appendChild(this.canvas)},d.Generator.prototype.doBuildRenderTree=function(a,b){if(null==a)return!1;3===a.nodeType&&(a.data=d.utils.collapseWhiteSpaces(a.data));var c=jQuery(a),e=d.Factory.createRenderTreeNode(c);1===a.nodeType&&e&&c.attr("data-id",e.id);var f,g=null,h=!1;if(null==e)return this.doBuildRenderTree(a.nextSibling,b),!1;if(b){if(!e.renderObject.isInline()&&b.openAnonymousBlock&&(b.openAnonymousBlock=null),!b.renderObject.isAnonymousBlock()&&b.renderObject.continuation)for(;b.renderObject.continuation;)b=b.renderObject.continuation;if(b.renderObject.isInlineFlow()){if(!e.renderObject.isInline()){for(var i=b,j=[];i&&i.renderObject.isInline();)j.push(i),i=i.parentNode;var k,l,m;if(i.renderObject.isAnonymousBlock())k=i,i=i.parentNode,l=d.Factory.createRenderTreeAnonymousBlock(),m=d.Factory.createRenderTreeAnonymousBlock();else{k=d.Factory.createRenderTreeAnonymousBlock(),l=d.Factory.createRenderTreeAnonymousBlock(),m=d.Factory.createRenderTreeAnonymousBlock();for(var n=[],o=i.firstChild;o;)n.push(o),o=o.nextSibling;for(f=0;f<n.length;f++)k.appendChild(n[f]);i.appendChild(k)}i.appendChild(l),i.appendChild(m),i.openAnonymousBlock=m;var p=m;for(f=j.length-1;f>=0;f--){var q=j[f].renderObject.clone();j[f].renderObject.continuation=q,q.renderObject.isInlineContinuation=!0,p.appendChild(q),p=q}b.renderObject.continuation=l,l.renderObject.continuation=p,b=l}}else{var r=b.renderObject.childrenInline();if(!r&&e.renderObject.isInline()||r&&!e.renderObject.isInline())if(b.renderObject.continuation)b=b.renderObject.continuation;else{for(var s,t=b.firstChild;null!==t;)t.renderObject.isInline()&&(s||(s=d.Factory.createRenderTreeAnonymousBlock(),b.insertBefore(s,t)),s.appendChild(t)),t=t.nextSibling;e.renderObject.isInline()&&(b.openAnonymousBlock?g=b.openAnonymousBlock:(g=d.Factory.createRenderTreeAnonymousBlock(),b.openAnonymousBlock=g,h=!0),g.appendChild(e))}}}(1===a.nodeType||9===a.nodeType)&&this.parseResources(e,a,c),b?g&&h?b.appendChild(g):g||b.appendChild(e):(this.renderTree=e,b=e,a=c.find("body").get(0)),this.doBuildRenderTree(a.firstChild,e),this.doBuildRenderTree(a.nextSibling,b)},d.Generator.prototype.parseResources=function(a,b,c){var e=a.renderObject.renderingStyle;if(9!==b.nodeType&&"img"===c.prop("tagName").toLowerCase()&&c.prop("src"))d.resources.ImageManager.get(c.prop("src"))||(console.log("Image was found: "+c.prop("src")),d.resources.ImageManager.set(c.prop("src"),c));else if("none"!==e.backgroundImage&&"url("===e.backgroundImage.substr(0,4).toLowerCase()){var f=d.utils.getBackgroundImage(e.backgroundImage);d.resources.ImageManager.get(f)||(console.log("Image was found: "+f),d.resources.ImageManager.set(f,f))}},d.Generator.prototype.checkInvariants=function(a){if(!a||!a.firstChild)return!1;var b=!0,c=a.firstChild,d=c.renderObject.isInline();if(a.renderObject.isInlineFlow()&&!d)b=!1;else for(;c;){if(d!==c.renderObject.isInline()){b=!1;break}c=c.nextSibling}b||(console.error("Invariant fail: "+a.tagName+"#"+a.id),console.log(a.parentNode),console.log(a.renderObject)),this.checkInvariants(a.firstChild),this.checkInvariants(a.nextSibling)},d.Generator.prototype.doLayout=function(){this.renderTree.renderObject.layout()},d.Generator.prototype.doPaint=function(){if(!this.canDraw||!d.resources.ImageManager.checkIfDone())return!1;this.isSupported||console.log("WARNING: This browser does not support the canvas element!");var a=jQuery(this.canvas);a.attr("width",this.renderTree.renderObject.width),a.attr("height",this.renderTree.renderObject.height),a.css("float","left"),jQuery("body").css("padding","0px").css("margin","0px"),this.renderTree.renderObject.paint(this.ctx)}}(jQuery);